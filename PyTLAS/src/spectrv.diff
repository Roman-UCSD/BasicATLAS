--- /dev/fd/63	2025-12-04 18:07:45.541524051 -0500
+++ /dev/fd/62	2025-12-04 18:07:45.541524051 -0500
@@ -1,4 +1,4 @@
-      PROGRAM SPECTRV
+      SUBROUTINE SPECTRV(in_abun)
 c     revised 4nov14   constants given D exponents
 c     revised 16dec97
       IMPLICIT REAL*8 (A-H,O-Z)
@@ -25,6 +25,7 @@
      1             GRDADB(kw),HSCALE(kw),FLXCNV(kw),VCONV(kw),MIXLTH,
      2             IFCONV
       REAL*8 MIXLTH
+      REAL*8 in_abun(100)
       COMMON /ELEM/ABUND(99),ATMASS(99),ELEM(99)
       COMMON/XABUND/XABUND(99),WTMOLE
       character*2 elem
@@ -47,6 +48,12 @@
       COMMON /PUT/PUT,IPUT
       COMMON /PZERO/PZERO,PCON,PRADK0,PTURB0,KNU(kw),PRADK(kw),EDENS(kw)
       REAL*8 KNU
+      INTEGER NUMPTS
+      PARAMETER (NUMPTS=2010001)
+      LOGICAL KEEP(NUMPTS)
+      INTEGER*1 MASKBYTE(NUMPTS)
+      INTEGER NBYTES
+      LOGICAL EXISTS
       COMMON /RAD/ACCRAD(kw),PRAD(kw)
       COMMON /RHOX/RHOX(kw),NRHOX
       COMMON /STATE/P(kw),XNE(kw),XNATOM(kw),RHO(kw),PTOTAL(kw)
@@ -115,38 +122,57 @@
 C     R1 IS THE RESIDUAL INTENSITY AT THE BOTTOM OF THE PLOT
 C     R2 IS THE RESIDUAL INTENSITY AT THE TOP
 C     PRDPOW AND PRDDOP ARE PARTIAL REDISTRIBUTION PARAMETERS
-      READ(25,1)RHOXJ,R1,R101,PH1,PC1,PSI1,PRDDOP,PRDPOW
-    1 FORMAT(8F10.5)
-      WRITE(6,1)RHOXJ,R1,R101,PH1,PC1,PSI1,PRDDOP,PRDPOW
+c      READ(25,1)RHOXJ,R1,R101,PH1,PC1,PSI1,PRDDOP,PRDPOW
+      N_F9=0
+      N_F7=0
+      RHOXJ=0.0
+      R1=0.
+      R101=1.
+      PH1=0.
+      PC1=0.
+      PSI1=0.
+      PRDDOP=0.
+      PRDPOW=0.
+c    1 FORMAT(8F10.5)
+c      WRITE(6,1)RHOXJ,R1,R101,PH1,PC1,PSI1,PRDDOP,PRDPOW
       SLOPE=100./(R101-R1)
       ORIGIN=1.5-R1*SLOPE
 c     OPEN(UNIT=5,SHARED,READONLY,TYPE='OLD')
       CALL READIN(20)
+      IF(IN_ABUN(2).GT.0)THEN
+      XSCALE=IN_ABUN(1)
+      ABUND(:)=IN_ABUN(2:)
+      XABUND(3:)=EXP(ABUND(3:)*2.30258509299405D0)*XSCALE
+      XABUND(1)=ABUND(1)
+      XABUND(2)=ABUND(2)
+      ENDIF
 C     IF(IFSURF.EQ.0)THEN
 C      WRITE(6,*)' SURFACE FLUX OR SURFACE INTENSITY?'
 C      CALL ABORT
 C      ENDIF
 C
-      OPEN(UNIT=10,STATUS='OLD',FORM='UNFORMATTED')
-      READ(10)
-      READ(10)NEDGE,(FRQEDG(IEDGE),WLEDGE(IEDGE),CMEDGE(IEDGE),
-     1     IEDGE=1,NEDGE)
-      write(6,6666)nedge
+c      OPEN(UNIT=10,STATUS='OLD',FORM='UNFORMATTED')
+      CALL loadf10_1(NEDGE,FRQEDG,WLEDGE,CMEDGE,NCON,CONFRQ)
+c      READ(10)
+c      READ(10)NEDGE,(FRQEDG(IEDGE),WLEDGE(IEDGE),CMEDGE(IEDGE),
+c     1     IEDGE=1,NEDGE)
+c      write(6,6666)nedge
  6666 format(I10)
-      READ(10)NCON,(CONFRQ(NU),NU=1,NCON)
-      write(6,6666)ncon
+c      READ(10)NCON,(CONFRQ(NU),NU=1,NCON)
+c      write(6,6666)ncon
       WLEDGE(1)=ABS(WLEDGE(1))
       DO 2001 IEDGE=2,NEDGE
       WLEDGE(IEDGE)=ABS(WLEDGE(IEDGE))
       HALFEDGE(IEDGE-1)=(WLEDGE(IEDGE-1)+WLEDGE(IEDGE))*.5
  2001 DELEDGE(IEDGE-1)=(WLEDGE(IEDGE)-WLEDGE(IEDGE-1))**2*.5
-      READ(10)
+c      READ(10)
       IREC=0
       DO 2003 J=1,NRHOX
-      READ(10)
-      READ(10)QCONTABS
-      READ(10)QCONTSCAT
-      READ(10)
+c      READ(10)
+c      READ(10)QCONTABS
+c      READ(10)QCONTSCAT
+c      READ(10)
+      CALL loadf10_2(J,QCONTABS,QCONTSCAT)
       NU=0
       DO 2002 IEDGE=1,NEDGE-1
       NU=NU+1
@@ -165,7 +191,7 @@
  2003 CONTINUE
       CLOSE(UNIT=10)
 C
-      write(6,6668)
+c      write(6,6668)
  6668 format (10x,'TAPE10')
       IFPRES=0
       ITEMP=1
@@ -207,23 +233,25 @@
       FSCAT(J)=0.
       IF(RHOX(J)/RHOXJ.LT.100.)FSCAT(J)=EXP(-RHOX(J)/RHOXJ)
     4 CONTINUE
-      CALL W('FSCAT ',FSCAT,NRHOX)
-      CALL W('BFUDGE',BFUDGE,NRHOX)
+c      CALL W('FSCAT ',FSCAT,NRHOX)
+c      CALL W('BFUDGE',BFUDGE,NRHOX)
     5 CONTINUE
       IFPRES=0
       ITEMP=1
-      REWIND 7
-      REWIND 9
-      READ(9)WLBEG,RESOLU,WLEND,LENGTH,N,LINOUT,TURBV,IFVAC
-      READ (9)NEDGE,(FRQEDG(IEDGE),WLEDGE(IEDGE),CMEDGE(IEDGE),
-     1IEDGE=1,NEDGE)
+      N_F7=0
+c      REWIND 7
+c      REWIND 9
+      CALL loadf93(WLBEG,RESOLU,WLEND,LENGTH,N,LINOUT,TURBV,IFVAC)
+c      READ(9)WLBEG,RESOLU,WLEND,LENGTH,N,LINOUT,TURBV,IFVAC
+c      READ(9)NEDGE,(FRQEDG(IEDGE),WLEDGE(IEDGE),CMEDGE(IEDGE),
+c     1IEDGE=1,NEDGE)
 C     PATCH TO PASS IFVAC TO PLOTSY
 c      TITLE(74)=1HA
       TITLE(1)='A'
 c      IF(IFVAC.EQ.1)TITLE(74)=1HV
       IF(IFVAC.EQ.1)TITLE(1)='V'
       N30=N+30
-      WRITE(6,11)WLBEG,RESOLU,WLEND,LENGTH,N
+c      WRITE(6,11)WLBEG,RESOLU,WLEND,LENGTH,N
    11 FORMAT(7H WLBEG=,F10.4,10H   RESOLU=,F10.1,9H   WLEND=,F10.4,
      110H   LENGTH=,I7,9H   NRHOX=,I2)
       N10=0
@@ -243,15 +271,33 @@
       NUMNU=LENGTH
       WLBEG=WBEGIN
       WLEND=WBEGIN*RATIO**(NUHI-1)
-      WRITE(6,31)NUMNU,DELTAW,WLBEG,WLEND
+c      WRITE(6,31)NUMNU,DELTAW,WLBEG,WLEND
    31 FORMAT(I10,3F13.4)
-      IF(IFSURF.EQ.1)WRITE(6,41)
+c      IF(IFSURF.EQ.1)WRITE(6,41)
    41 FORMAT(13H SURFACE FLUX)
-      IF(IFSURF.EQ.2)WRITE(6,42)NMU,(ANGLE(MU),MU=1,NMU)
+c      IF(IFSURF.EQ.2)WRITE(6,42)NMU,(ANGLE(MU),MU=1,NMU)
    42 FORMAT(18H SURFACE INTENSITY,I3/20F6.3)
       NMU2=NMU*2
 C     IF(PRDDOP.GT.0.)CALL PRDJNU(RHOXJ)
       IEDGE=1
+
+C Load the mask
+      NBYTES = NUHI - NULO + 1
+      INQUIRE(FILE='mask.bin', EXIST=EXISTS)
+      IF (EXISTS) THEN
+      OPEN(UNIT=99, FILE='mask.bin', STATUS='OLD', ACCESS='STREAM',
+     &     FORM='UNFORMATTED', ACTION='READ')
+      READ(99) MASKBYTE(1:NBYTES)
+      CLOSE(99)
+      DO NU = 1, NBYTES
+         KEEP(NU) = (MASKBYTE(NU) .NE. 0)
+      END DO
+      ELSE
+      DO NU = 1, NBYTES
+            KEEP(NU) = .TRUE.
+         END DO
+      END IF
+
       DO 25 NU=NULO,NUHI
 C     NUPRD=NU
       WAVE=WBEGIN*RATIO**(NU-1)
@@ -288,9 +334,11 @@
    21 CONTINUE
 C      IF(IFOP(14).EQ.1)CALL HLINOP
 C      IF(IFOP(17).EQ.1)CALL XLINOP
-      IF(NU.EQ.1)WRITE(6,33)
+c      IF(NU.EQ.1)WRITE(6,33)
    33 FORMAT(1H1)
-      READ(9)ASYNTH
+      N_F9=N_F9+1
+      CALL load_asynth(N_F9,ASYNTH)
+      IF (.NOT. KEEP(NU) .AND. NU.GT.1) CYCLE
       DO 241 J=1,NRHOX
 C      ALINE(J)=AHLINE(J)+ASYNTH(J)*(1.-FSCAT(J))+AXLINE(J)
       ALINE(J)=ASYNTH(J)*(1.-FSCAT(J))
@@ -313,7 +361,7 @@
       IPLOT=RESID*SLOPE+ORIGIN
       IPLOT=MAX0(1,MIN0(101,IPLOT))
       APLOT(IPLOT)='X'
-      WRITE(6,2300)NU,WAVE,IRESID,APLOT
+c      WRITE(6,2300)NU,WAVE,IRESID,APLOT
  2300 FORMAT(1H ,I5,F11.4,I7,101A1)
       APLOT(IPLOT)=(' ')
   230 CONTINUE
@@ -321,20 +369,24 @@
       Q(MU+NMU)=SURF(MU)
   250 CONTINUE
       IF(NU.GT.1)GO TO 251
-      REWIND 7
-      WRITE(7)TEFF,GLOG,TITLE,WBEGIN,DELTAW,NUMNU,IFSURF,NMU,ANGLE,
-     1NEDGE,WLEDGE
+c      REWIND 7
+c      WRITE(7)TEFF,GLOG,TITLE,WBEGIN,DELTAW,NUMNU,IFSURF,NMU,ANGLE,
+c     1NEDGE,WLEDGE
   251 CONTINUE
-      WRITE(7)(Q(I),I=1,NMU2)
+c      WRITE(7)(Q(I),I=1,NMU2)
+      N_F7 = N_F7 + 1
+      CALL update_spectrum(N_F7,Q)
    25 CONTINUE
 C
       IF(NMU.GT.10)IFSURF=1
       NMU=1
       MU=1
-      READ(9)NLINES
+c      READ(9)NLINES
+      NLINES=0
       N910=NLINES+N10
-      WRITE(7)N910
-      WRITE(6,80)NLINES,N10,N910
+      CALL update_meta(WBEGIN,DELTAW,NUMNU)
+c      WRITE(7)N910
+c      WRITE(6,80)NLINES,N10,N910
    80 FORMAT(3I10)
       IF(NLINES.EQ.0)GO TO 100
       WAVOLD=0.
@@ -342,6 +394,7 @@
       DO 90 ILINE=1,NLINES
       READ(9)LINDAT8I,LABEL,LABELP,OTHER1,OTHER2,
      1 LINDAT8II,LINDAT4I,REF,LINDAT4II,ALINEC
+      WRITE(*,*) 'Robin'
       WAVE=WLVAC
       IF(WAVE.LT.WAVOLD)IEDGE=1
       WAVOLD=WAVE
@@ -402,8 +455,8 @@
      1 0PF10.4,I4,F6.2,F6.2,F6.2,A4,I2,I2,I3,F7.3,I3,F7.3,
      2A10,A10,F7.4,F7.3,3F6.2,F10.4)
 c      WRITE(7)LINDAT8,LINDAT
-      write(7)LINDAT8I,LABEL,LABELP,OTHER1,OTHER2,
-     1     LINDAT8II,LINDAT4I,REF,LINDAT4II
+c      write(7)LINDAT8I,LABEL,LABELP,OTHER1,OTHER2,
+c     1     LINDAT8II,LINDAT4I,REF,LINDAT4II
  90   CONTINUE
   100 CONTINUE
       CLOSE(UNIT=9)
@@ -457,16 +510,16 @@
   103 CONCEN=SURF(MU)
       RESID=CENTER/CONCEN
 c     29oct07 replaced missing comma after OTHER2  
-      WRITE(6,99)WL,GFLOG,XJ,E,XJP,EP,CODE,LABEL,LABELP,WLVAC,RESID,
-     BCENTER,CONCEN,
-     1WL,NELION,GR,GS,GW,REF,NBLO,NBUP,ISO1,X1,ISO2,X2,OTHER1,OTHER2,
-     2DWL,DGFLOG,DGAMMAR,DGAMMAS,DGAMMAW
+c      WRITE(6,99)WL,GFLOG,XJ,E,XJP,EP,CODE,LABEL,LABELP,WLVAC,RESID,
+c     BCENTER,CONCEN,
+c     1WL,NELION,GR,GS,GW,REF,NBLO,NBUP,ISO1,X1,ISO2,X2,OTHER1,OTHER2,
+c     2DWL,DGFLOG,DGAMMAR,DGAMMAS,DGAMMAW
 C      WRITE(7)LINDAT8,LINDAT
-      write(7)LINDAT8I,LABEL,LABELP,OTHER1,OTHER2,
-     1     LINDAT8II,LINDAT4I,REF,LINDAT4II
+c      write(7)LINDAT8I,LABEL,LABELP,OTHER1,OTHER2,
+c     1     LINDAT8II,LINDAT4I,REF,LINDAT4II
   110 CONTINUE
       CLOSE(UNIT=20)
-  111 CALL EXIT
+  111 RETURN
       END
       SUBROUTINE LINCEN
       RETURN
